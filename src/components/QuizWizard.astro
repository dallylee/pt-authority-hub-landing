---
---

<div id="quiz-wizard" class="bg-panel border border-white/5 rounded-2xl overflow-hidden shadow-2xl relative">
  <!-- Progress Bar -->
  <div class="h-1 bg-white/5 w-full">
    <div id="progress-bar" class="h-full bg-accent transition-all duration-500 w-[20%]"></div>
  </div>

  <form id="lead-form" class="p-6 sm:p-10 space-y-8">
    <!-- Honeypot -->
    <div class="hidden">
      <input type="text" name="company" tabindex="-1" autocomplete="off" />
    </div>

    <!-- Step 1: Contact -->
    <div data-step="1" class="space-y-6">
      <div class="space-y-2">
        <label class="block text-xs font-bold text-accent uppercase tracking-widest">Email Address *</label>
        <input type="email" name="email" required placeholder="name@example.com" class="w-full bg-bg border border-white/10 rounded-lg px-4 py-3 text-text focus:outline-none focus:border-accent transition-colors" />
      </div>
      <div class="space-y-2">
        <label class="block text-xs font-bold text-accent uppercase tracking-widest">First Name *</label>
        <input type="text" name="first_name" required placeholder="John" class="w-full bg-bg border border-white/10 rounded-lg px-4 py-3 text-text focus:outline-none focus:border-accent transition-colors" />
      </div>
      <div class="space-y-2">
        <label class="block text-xs font-bold text-accent uppercase tracking-widest">Location *</label>
        <select name="location" required class="w-full bg-bg border border-white/10 rounded-lg px-4 py-3 text-text focus:outline-none focus:border-accent transition-colors">
          <option value="">Select Location...</option>
          <option value="London">London</option>
          <option value="UK (outside London)">UK (outside London)</option>
          <option value="Outside the UK">Outside the UK</option>
          <option value="Prefer not to say">Prefer not to say</option>
        </select>
      </div>
    </div>

    <!-- Step 2: Goal and Urgency -->
    <div data-step="2" class="space-y-6 hidden">
      <div class="space-y-4">
        <label class="block text-xs font-bold text-accent uppercase tracking-widest">What Is Your Main Goal Right Now? *</label>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          {["Lose Fat and Look Leaner", "Build Strength", "Build Muscle", "Improve Conditioning and Endurance", "Improve Energy and Recovery", "Get Consistent Again"].map(goal => (
            <label class="flex items-center gap-3 p-4 bg-bg border border-white/10 rounded-lg cursor-pointer hover:border-accent/50 transition-colors group">
              <input type="radio" name="main_goal" value={goal} required class="sr-only peer" />
              <div class="w-4 h-4 rounded-full border border-white/20 peer-checked:bg-accent peer-checked:border-accent flex-shrink-0"></div>
              <span class="text-sm text-muted group-hover:text-text">{goal}</span>
            </label>
          ))}
          <label class="flex flex-col gap-2 p-4 bg-bg border border-white/10 rounded-lg cursor-pointer hover:border-accent/50 transition-colors group sm:col-span-2">
            <div class="flex items-center gap-3">
              <input type="radio" name="main_goal" value="Other" class="sr-only peer" id="main_goal_other_radio" />
              <div class="w-4 h-4 rounded-full border border-white/20 peer-checked:bg-accent peer-checked:border-accent flex-shrink-0"></div>
              <span class="text-sm text-muted group-hover:text-text">Other</span>
            </div>
            <input type="text" name="main_goal_other" id="main_goal_other_field" placeholder="Tell Us Briefly..." class="hidden bg-bg border border-white/10 rounded-lg px-3 py-2 text-sm text-text focus:outline-none focus:border-accent transition-colors mt-2" />
          </label>
        </div>
      </div>

      <div class="space-y-2">
        <label class="block text-xs font-bold text-accent uppercase tracking-widest">When Would You Like to Start? *</label>
        <select name="start_timing" required class="w-full bg-bg border border-white/10 rounded-lg px-4 py-3 text-text focus:outline-none focus:border-accent transition-colors">
          <option value="">Select...</option>
          <option value="This Week">This Week</option>
          <option value="In 2–3 Weeks">In 2–3 Weeks</option>
          <option value="In 4–6 Weeks">In 4–6 Weeks</option>
          <option value="Just Researching for Now">Just Researching for Now</option>
        </select>
      </div>

      <div class="space-y-4">
        <label class="block text-xs font-bold text-accent uppercase tracking-widest">What Is Your Biggest Blocker Right Now? *</label>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          {["I Train, but Results Are Not Happening", "I Cannot Stay Consistent", "I Do Not Know What to Do (Conflicting Advice)", "Low Energy, Poor Recovery, Stress", "Nutrition Consistency", "Time Constraints"].map(blocker => (
            <label class="flex items-center gap-3 p-4 bg-bg border border-white/10 rounded-lg cursor-pointer hover:border-accent/50 transition-colors group">
              <input type="radio" name="biggest_blocker" value={blocker} required class="sr-only peer" />
              <div class="w-4 h-4 rounded-full border border-white/20 peer-checked:bg-accent peer-checked:border-accent flex-shrink-0"></div>
              <span class="text-sm text-muted group-hover:text-text">{blocker}</span>
            </label>
          ))}
          <label class="flex flex-col gap-2 p-4 bg-bg border border-white/10 rounded-lg cursor-pointer hover:border-accent/50 transition-colors group sm:col-span-2">
            <div class="flex items-center gap-3">
              <input type="radio" name="biggest_blocker" value="Other" class="sr-only peer" id="biggest_blocker_other_radio" />
              <div class="w-4 h-4 rounded-full border border-white/20 peer-checked:bg-accent peer-checked:border-accent flex-shrink-0"></div>
              <span class="text-sm text-muted group-hover:text-text">Other</span>
            </div>
            <input type="text" name="biggest_blocker_other" id="biggest_blocker_other_field" placeholder="Tell Us Briefly..." class="hidden bg-bg border border-white/10 rounded-lg px-3 py-2 text-sm text-text focus:outline-none focus:border-accent transition-colors mt-2" />
          </label>
        </div>
      </div>
    </div>

    <!-- Step 3: Commitment and Fit -->
    <div data-step="3" class="space-y-6 hidden">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div class="space-y-2">
          <label class="block text-xs font-bold text-accent uppercase tracking-widest">How Many Days per Week Do You Train Right Now? *</label>
          <select name="training_days_current" required class="w-full bg-bg border border-white/10 rounded-lg px-4 py-3 text-text focus:outline-none focus:border-accent transition-colors">
            <option value="">Select...</option>
            <option value="0–1">0–1</option>
            <option value="2–3">2–3</option>
            <option value="4–5">4–5</option>
            <option value="6+">6+</option>
          </select>
        </div>
        <div class="space-y-2">
          <label class="block text-xs font-bold text-accent uppercase tracking-widest">Realistically, How Much Time Can You Commit per Week? *</label>
          <select name="time_commitment_weekly" required class="w-full bg-bg border border-white/10 rounded-lg px-4 py-3 text-text focus:outline-none focus:border-accent transition-colors">
            <option value="">Select...</option>
            <option value="1–2 Hours">1–2 Hours</option>
            <option value="2–3 Hours">2–3 Hours</option>
            <option value="3–5 Hours">3–5 Hours</option>
            <option value="5+ Hours">5+ Hours</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div class="space-y-2">
          <label class="block text-xs font-bold text-accent uppercase tracking-widest">What Monthly Investment Range Feels Realistic for Coaching? *</label>
          <select name="monthly_investment" required class="w-full bg-bg border border-white/10 rounded-lg px-4 py-3 text-text focus:outline-none focus:border-accent transition-colors">
            <option value="">Select...</option>
            <option value="Under £150/month">Under £150/month</option>
            <option value="£150–£300/month">£150–£300/month</option>
            <option value="£300–£600/month">£300–£600/month</option>
            <option value="£600+/month">£600+/month</option>
            <option value="Not Sure Yet">Not Sure Yet</option>
          </select>
        </div>
        <div class="space-y-2">
          <label class="block text-xs font-bold text-accent uppercase tracking-widest">What Type of Coaching Do You Prefer? *</label>
          <select name="coaching_preference" required class="w-full bg-bg border border-white/10 rounded-lg px-4 py-3 text-text focus:outline-none focus:border-accent transition-colors">
            <option value="">Select...</option>
            <option value="1:1 In-Person (London)">1:1 In-Person (London)</option>
            <option value="1:1 Online">1:1 Online</option>
            <option value="Hybrid">Hybrid</option>
            <option value="Not Sure">Not Sure</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Step 4: Safety and Constraints (NEW) -->
    <div data-step="4" class="space-y-6 hidden">
      <div class="space-y-4">
        <label class="block text-xs font-bold text-accent uppercase tracking-widest">Any Injuries or Issues That Affect Training Right Now? *</label>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          {["None", "Past Injury (Not Limiting)", "Current Issue (Limits Training)", "Prefer not to say"].map(option => (
            <label class="flex items-center gap-3 p-4 bg-bg border border-white/10 rounded-lg cursor-pointer hover:border-accent/50 transition-colors group">
              <input type="radio" name="constraints" value={option} required class="sr-only peer" />
              <div class="w-4 h-4 rounded-full border border-white/20 peer-checked:bg-accent peer-checked:border-accent flex-shrink-0"></div>
              <span class="text-sm text-muted group-hover:text-text">{option}</span>
            </label>
          ))}
        </div>
        <p class="text-[11px] text-muted leading-relaxed">This is not medical advice, it helps tailor recommendations.</p>
      </div>
    </div>

    <!-- Step 5: Optional Upload Decision -->
    <div data-step="5" class="space-y-6 hidden">
      <div class="space-y-4">
        <label class="block text-xs font-bold text-accent uppercase tracking-widest">Want a Deeper Audit by Uploading Your Stats? *</label>
        <div class="grid grid-cols-1 gap-3">
          <label class="flex items-center gap-3 p-4 bg-bg border border-white/10 rounded-lg cursor-pointer hover:border-accent/50 transition-colors group">
            <input type="radio" name="wants_upload" value="Yes" required class="sr-only peer" />
            <div class="w-4 h-4 rounded-full border border-white/20 peer-checked:bg-accent peer-checked:border-accent flex-shrink-0"></div>
            <span class="text-sm text-muted group-hover:text-text">Yes, I Will Upload (Recommended)</span>
          </label>
          <label class="flex items-center gap-3 p-4 bg-bg border border-white/10 rounded-lg cursor-pointer hover:border-accent/50 transition-colors group">
            <input type="radio" name="wants_upload" value="No" class="sr-only peer" />
            <div class="w-4 h-4 rounded-full border border-white/20 peer-checked:bg-accent peer-checked:border-accent flex-shrink-0"></div>
            <span class="text-sm text-muted group-hover:text-text">No, Just Use My Answers</span>
          </label>
        </div>
      </div>

      <div class="space-y-4 pt-4 border-t border-white/5">
        <label class="flex items-center gap-3 cursor-pointer group">
          <input type="checkbox" name="consent" required class="sr-only peer" />
          <div class="w-5 h-5 border border-white/20 rounded peer-checked:bg-accent peer-checked:border-accent flex items-center justify-center transition-colors">
            <svg class="w-3.5 h-3.5 text-bg hidden peer-checked:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
          </div>
          <span class="text-sm text-muted group-hover:text-text">I consent to the processing of my data to receive the performance audit. *</span>
        </label>
        <p class="text-[11px] text-muted leading-relaxed">This is coaching guidance, not medical advice. If you have medical concerns, consult your GP or clinician.</p>
      </div>
    </div>

    <!-- Sticky Mobile Footer / Action Bar -->
    <div class="fixed bottom-0 left-0 right-0 p-4 bg-bg/95 backdrop-blur-md border-t border-white/5 sm:relative sm:bg-transparent sm:border-none sm:p-0 flex items-center justify-between gap-4 z-20">
      <button type="button" id="prev-btn" class="hidden px-6 py-3 rounded-lg text-sm font-bold text-muted hover:text-text hover:bg-white/5 transition-all">Back</button>
      <div class="flex-grow"></div>
      <button type="button" id="next-btn" class="px-8 py-3 bg-accent text-bg rounded-lg text-sm font-bold hover:brightness-110 transition-all">Continue</button>
      <button type="submit" id="submit-btn" class="hidden px-8 py-3 bg-accent text-bg rounded-lg text-sm font-bold hover:brightness-110 transition-all">Get My Audit</button>
    </div>

    <!-- Error State -->
    <div id="form-error" class="hidden p-4 bg-red-500/10 border border-red-500/20 rounded-lg text-red-500 text-sm text-center">
      Something went wrong. Please try again.
    </div>
  </form>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="hidden absolute inset-0 bg-bg/80 backdrop-blur-sm z-30 flex items-center justify-center">
    <div class="text-center">
      <div class="w-10 h-10 border-2 border-accent border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-xs font-bold text-accent uppercase tracking-widest">Submitting your audit...</p>
    </div>
  </div>

  <!-- Success State (shown after submit) -->
  <div id="success-state" class="hidden p-6 sm:p-10 space-y-8">
    <div class="text-center">
      <div class="w-16 h-16 mx-auto bg-accent/10 border border-accent/20 rounded-full flex items-center justify-center mb-6">
        <svg class="w-8 h-8 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      </div>
      <h2 class="text-2xl font-bold text-text mb-4">Thanks, Your Audit Is Received.</h2>
      <p class="text-muted leading-relaxed">
        Reply within <strong class="text-text">24 hours (business days)</strong>.
      </p>
    </div>

    <!-- Inline Upload Panel (only if wants_upload=Yes) -->
    <div id="inline-upload-panel" data-upload-panel="1" class="hidden border border-accent/20 rounded-xl bg-accent/5 p-6 space-y-4">
      <h3 class="text-lg font-bold text-text">Optional: Upload Your 30-Day Summary</h3>
      <p class="text-sm text-muted">Screenshots or exports are fine. Accepted formats: PDF, JPG/PNG, CSV.</p>
      <p class="text-xs text-muted italic">Examples: Apple Health, Garmin, Strava, WHOOP, Oura, Fitbit</p>
      <p class="text-[11px] text-muted">Please do not upload medical documents.</p>
      
      <div class="bg-panel border border-white/5 rounded-lg overflow-hidden">
        <iframe 
          id="tally-upload-iframe"
          data-tally-src=""
          loading="lazy"
          width="100%"
          height="400"
          frameborder="0"
          marginheight="0"
          marginwidth="0"
          title="Upload Your Stats"
        ></iframe>
      </div>
      
      <div class="text-center pt-4">
        <button type="button" id="skip-upload-btn" class="text-sm text-muted hover:text-accent underline transition-colors">
          Skip for Now – Proceed with Quiz Answers Only
        </button>
      </div>
    </div>

    <!-- After upload skipped or not needed -->
    <div id="upload-skipped-msg" class="hidden text-center text-sm text-muted">
      <p>Your audit will proceed using your quiz answers. Check your inbox!</p>
    </div>

    <div class="text-center pt-4">
      <a href="/" class="text-xs text-muted hover:text-accent uppercase tracking-widest font-mono transition-colors">
        ← Back to Home
      </a>
    </div>
  </div>
</div>

<script is:inline>
  (() => {
    const form = document.getElementById('lead-form');
    const progressBar = document.getElementById('progress-bar');
    const nextBtn = document.getElementById('next-btn');
    const prevBtn = document.getElementById('prev-btn');
    const submitBtn = document.getElementById('submit-btn');
    const errorMsg = document.getElementById('form-error');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    let currentStep = 1;
    const totalSteps = 5;

    // "Other" reveal logic
    function setupOtherReveal(radioName, textFieldId) {
      const radios = document.querySelectorAll(`input[name="${radioName}"]`);
      const textField = document.getElementById(textFieldId);
      
      radios.forEach(radio => {
        radio.addEventListener('change', () => {
          if (radio.value === 'Other' && radio.checked) {
            textField.classList.remove('hidden');
            textField.required = true;
          } else if (radio.checked) {
            textField.classList.add('hidden');
            textField.required = false;
            textField.value = '';
          }
        });
      });
    }

    // Initialize Other reveal for main_goal and biggest_blocker
    setupOtherReveal('main_goal', 'main_goal_other_field');
    setupOtherReveal('biggest_blocker', 'biggest_blocker_other_field');

    function updateUI() {
      // Show/Hide steps
      document.querySelectorAll('[data-step]').forEach(el => {
        el.classList.toggle('hidden', parseInt(el.dataset.step) !== currentStep);
      });

      // Update progress
      progressBar.style.width = `${(currentStep / totalSteps) * 100}%`;

      // Update buttons
      prevBtn.classList.toggle('hidden', currentStep === 1);
      nextBtn.classList.toggle('hidden', currentStep === totalSteps);
      submitBtn.classList.toggle('hidden', currentStep !== totalSteps);
      
      // Scroll to top of wizard on mobile
      if (window.innerWidth < 640) {
        document.getElementById('quiz-wizard').scrollIntoView({ behavior: 'smooth' });
      }
    }

    function validateStep(step) {
      const stepEl = document.querySelector(`[data-step="${step}"]`);
      const inputs = stepEl.querySelectorAll('input[required], select[required]');
      
      let isValid = true;
      let firstInvalid = null;

      inputs.forEach(input => {
        if (input.type === 'radio') {
          const groupName = input.name;
          const checked = stepEl.querySelector(`input[name="${groupName}"]:checked`);
          if (!checked) {
            isValid = false;
            if (!firstInvalid) firstInvalid = input.parentElement;
          }
        } else if (input.type === 'checkbox') {
          if (!input.checked) {
            isValid = false;
            if (!firstInvalid) firstInvalid = input.parentElement;
          }
        } else {
          if (!input.value.trim()) {
            isValid = false;
            if (!firstInvalid) firstInvalid = input;
          }
        }
      });

      if (!isValid && firstInvalid) {
        firstInvalid.focus?.();
        firstInvalid.classList.add('border-red-500/50');
        setTimeout(() => firstInvalid.classList.remove('border-red-500/50'), 2000);
      }

      return isValid;
    }

    nextBtn.addEventListener('click', () => {
      if (validateStep(currentStep)) {
        currentStep++;
        updateUI();
      }
    });

    prevBtn.addEventListener('click', () => {
      currentStep--;
      updateUI();
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!validateStep(currentStep)) return;

      errorMsg.classList.add('hidden');
      loadingOverlay.classList.remove('hidden');

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      
      // Handle "Other" values
      if (data.main_goal === 'Other') {
        data.main_goal = `Other: ${data.main_goal_other || ''}`;
      }
      if (data.biggest_blocker === 'Other') {
        data.biggest_blocker = `Other: ${data.biggest_blocker_other || ''}`;
      }
      
      delete data.main_goal_other;
      delete data.biggest_blocker_other;

      try {
        const response = await fetch('/api/lead', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.ok) {
          // Hide form, show success state
          loadingOverlay.classList.add('hidden');
          form.classList.add('hidden');
          
          const successState = document.getElementById('success-state');
          const uploadPanel = document.getElementById('inline-upload-panel');
          const uploadSkippedMsg = document.getElementById('upload-skipped-msg');
          const tallyIframe = document.getElementById('tally-upload-iframe');
          const skipBtn = document.getElementById('skip-upload-btn');
          
          successState.classList.remove('hidden');
          
          // If user selected upload=Yes, show the upload panel with Tally embed
          if (data.wants_upload === 'Yes') {
            uploadPanel.classList.remove('hidden');
            
            // Build Tally embed URL with email prefill
            const email = encodeURIComponent(data.email || '');
            const leadId = result.lead_id ? encodeURIComponent(result.lead_id) : '';
            let tallyUrl = `https://tally.so/embed/pbyXyJ?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1`;
            if (email) {
              tallyUrl += `&email=${email}`;
            }
            if (leadId) {
              tallyUrl += `&lead_id=${leadId}`;
            }
            tallyIframe.src = tallyUrl;
            tallyIframe.dataset.tallySrc = tallyUrl;
            
            // Load Tally widget
            if (typeof Tally !== 'undefined') {
              Tally.loadEmbeds();
            }
          } else {
            // User selected No upload
            uploadSkippedMsg.classList.remove('hidden');
          }
          
          // Handle skip button
          if (skipBtn) {
            skipBtn.addEventListener('click', () => {
              uploadPanel.classList.add('hidden');
              uploadSkippedMsg.classList.remove('hidden');
            });
          }
          
          // Scroll to top
          document.getElementById('quiz-wizard').scrollIntoView({ behavior: 'smooth' });
          
        } else {
          throw new Error(result.error || 'Submission failed');
        }
      } catch (err) {
        console.error('Quiz Submission Error:', err);
        loadingOverlay.classList.add('hidden');
        errorMsg.classList.remove('hidden');
        errorMsg.textContent = err.message || 'Something went wrong. Please try again.';
      }
    });
  })();
</script>

<style>
  /* Prevent scrolling on mobile when sticky footer is active */
  @media (max-width: 640px) {
    #quiz-wizard {
      padding-bottom: 80px;
    }
  }
</style>
