---
---

<div id="quiz-wizard" class="bg-panel border border-white/5 rounded-2xl overflow-hidden shadow-2xl relative">
  <!-- Progress Bar -->
  <div class="h-1 bg-white/5 w-full">
    <div id="progress-bar" class="h-full bg-accent transition-all duration-500 w-[20%]"></div>
  </div>

  <form id="lead-form" class="p-6 sm:p-10 space-y-8">
    <!-- Honeypot -->
    <div class="hidden">
      <input type="text" name="company" tabindex="-1" autocomplete="off" />
    </div>

    <!-- Step 1: Contact -->
    <div data-step="1" class="space-y-6">
      <div class="space-y-2">
        <label class="block text-xs font-bold text-accent uppercase tracking-widest">Email Address *</label>
        <input type="email" name="email" required placeholder="name@example.com" class="w-full bg-bg border border-white/10 rounded-lg px-4 py-3 text-text focus:outline-none focus:border-accent transition-colors" />
      </div>
      <div class="space-y-2">
        <label class="block text-xs font-bold text-accent uppercase tracking-widest">First Name *</label>
        <input type="text" name="first_name" required placeholder="John" class="w-full bg-bg border border-white/10 rounded-lg px-4 py-3 text-text focus:outline-none focus:border-accent transition-colors" />
      </div>
      <div class="space-y-2">
        <label class="block text-xs font-bold text-accent uppercase tracking-widest">Location *</label>
        <select name="location" required class="w-full bg-bg border border-white/10 rounded-lg px-4 py-3 text-text focus:outline-none focus:border-accent transition-colors">
          <option value="">Select Location...</option>
          <option value="London">London</option>
          <option value="UK (outside London)">UK (outside London)</option>
          <option value="Outside the UK">Outside the UK</option>
          <option value="Prefer not to say">Prefer not to say</option>
        </select>
      </div>
    </div>

    <!-- Step 2: Goal and Urgency -->
    <div data-step="2" class="space-y-6 hidden">
      <div class="space-y-4">
        <label class="block text-xs font-bold text-accent uppercase tracking-widest">What Is Your Main Goal Right Now? *</label>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          {["Lose Fat and Look Leaner", "Build Strength", "Build Muscle", "Improve Conditioning and Endurance", "Improve Energy and Recovery", "Get Consistent Again"].map(goal => (
            <label class="flex items-center gap-3 p-4 bg-bg border border-white/10 rounded-lg cursor-pointer hover:border-accent/50 transition-colors group">
              <input type="radio" name="main_goal" value={goal} required class="sr-only peer" />
              <div class="w-4 h-4 rounded-full border border-white/20 peer-checked:bg-accent peer-checked:border-accent flex-shrink-0"></div>
              <span class="text-sm text-muted group-hover:text-text">{goal}</span>
            </label>
          ))}
          <label class="flex flex-col gap-2 p-4 bg-bg border border-white/10 rounded-lg cursor-pointer hover:border-accent/50 transition-colors group sm:col-span-2">
            <div class="flex items-center gap-3">
              <input type="radio" name="main_goal" value="Other" class="sr-only peer" id="main_goal_other_radio" />
              <div class="w-4 h-4 rounded-full border border-white/20 peer-checked:bg-accent peer-checked:border-accent flex-shrink-0"></div>
              <span class="text-sm text-muted group-hover:text-text">Other</span>
            </div>
            <input type="text" name="main_goal_other" id="main_goal_other_field" placeholder="Tell Us Briefly..." class="hidden bg-bg border border-white/10 rounded-lg px-3 py-2 text-sm text-text focus:outline-none focus:border-accent transition-colors mt-2" />
          </label>
        </div>
      </div>

      <div class="space-y-2">
        <label class="block text-xs font-bold text-accent uppercase tracking-widest">When Would You Like to Start? *</label>
        <select name="start_timing" required class="w-full bg-bg border border-white/10 rounded-lg px-4 py-3 text-text focus:outline-none focus:border-accent transition-colors">
          <option value="">Select...</option>
          <option value="This Week">This Week</option>
          <option value="In 2–3 Weeks">In 2–3 Weeks</option>
          <option value="In 4–6 Weeks">In 4–6 Weeks</option>
          <option value="Just Researching for Now">Just Researching for Now</option>
        </select>
      </div>

      <div class="space-y-4">
        <label class="block text-xs font-bold text-accent uppercase tracking-widest">What Is Your Biggest Blocker Right Now? *</label>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          {["I Train, but Results Are Not Happening", "I Cannot Stay Consistent", "I Do Not Know What to Do (Conflicting Advice)", "Low Energy, Poor Recovery, Stress", "Nutrition Consistency", "Time Constraints"].map(blocker => (
            <label class="flex items-center gap-3 p-4 bg-bg border border-white/10 rounded-lg cursor-pointer hover:border-accent/50 transition-colors group">
              <input type="radio" name="biggest_blocker" value={blocker} required class="sr-only peer" />
              <div class="w-4 h-4 rounded-full border border-white/20 peer-checked:bg-accent peer-checked:border-accent flex-shrink-0"></div>
              <span class="text-sm text-muted group-hover:text-text">{blocker}</span>
            </label>
          ))}
          <label class="flex flex-col gap-2 p-4 bg-bg border border-white/10 rounded-lg cursor-pointer hover:border-accent/50 transition-colors group sm:col-span-2">
            <div class="flex items-center gap-3">
              <input type="radio" name="biggest_blocker" value="Other" class="sr-only peer" id="biggest_blocker_other_radio" />
              <div class="w-4 h-4 rounded-full border border-white/20 peer-checked:bg-accent peer-checked:border-accent flex-shrink-0"></div>
              <span class="text-sm text-muted group-hover:text-text">Other</span>
            </div>
            <input type="text" name="biggest_blocker_other" id="biggest_blocker_other_field" placeholder="Tell Us Briefly..." class="hidden bg-bg border border-white/10 rounded-lg px-3 py-2 text-sm text-text focus:outline-none focus:border-accent transition-colors mt-2" />
          </label>
        </div>
      </div>
    </div>

    <!-- Step 3: Commitment and Fit -->
    <div data-step="3" class="space-y-6 hidden">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div class="space-y-2">
          <label class="block text-xs font-bold text-accent uppercase tracking-widest">How Many Days per Week Do You Train Right Now? *</label>
          <select name="training_days_current" required class="w-full bg-bg border border-white/10 rounded-lg px-4 py-3 text-text focus:outline-none focus:border-accent transition-colors">
            <option value="">Select...</option>
            <option value="0–1">0–1</option>
            <option value="2–3">2–3</option>
            <option value="4–5">4–5</option>
            <option value="6+">6+</option>
          </select>
        </div>
        <div class="space-y-2">
          <label class="block text-xs font-bold text-accent uppercase tracking-widest">Realistically, How Much Time Can You Commit per Week? *</label>
          <select name="time_commitment_weekly" required class="w-full bg-bg border border-white/10 rounded-lg px-4 py-3 text-text focus:outline-none focus:border-accent transition-colors">
            <option value="">Select...</option>
            <option value="1–2 Hours">1–2 Hours</option>
            <option value="2–3 Hours">2–3 Hours</option>
            <option value="3–5 Hours">3–5 Hours</option>
            <option value="5+ Hours">5+ Hours</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div class="space-y-2">
          <label class="block text-xs font-bold text-accent uppercase tracking-widest">What Monthly Investment Range Feels Realistic for Coaching? *</label>
          <select name="monthly_investment" required class="w-full bg-bg border border-white/10 rounded-lg px-4 py-3 text-text focus:outline-none focus:border-accent transition-colors">
            <option value="">Select...</option>
            <option value="Under £150/month">Under £150/month</option>
            <option value="£150–£300/month">£150–£300/month</option>
            <option value="£300–£600/month">£300–£600/month</option>
            <option value="£600+/month">£600+/month</option>
            <option value="Not Sure Yet">Not Sure Yet</option>
          </select>
        </div>
        <div class="space-y-2">
          <label class="block text-xs font-bold text-accent uppercase tracking-widest">What Type of Coaching Do You Prefer? *</label>
          <select name="coaching_preference" required class="w-full bg-bg border border-white/10 rounded-lg px-4 py-3 text-text focus:outline-none focus:border-accent transition-colors">
            <option value="">Select...</option>
            <option value="1:1 In-Person (London)">1:1 In-Person (London)</option>
            <option value="1:1 Online">1:1 Online</option>
            <option value="Hybrid">Hybrid</option>
            <option value="Not Sure">Not Sure</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Step 4: Safety and Constraints (NEW) -->
    <div data-step="4" class="space-y-6 hidden">
      <div class="space-y-4">
        <label class="block text-xs font-bold text-accent uppercase tracking-widest">Any Injuries or Issues That Affect Training Right Now? *</label>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <label class="flex items-center gap-3 p-4 bg-bg border border-white/10 rounded-lg cursor-pointer hover:border-accent/50 transition-colors group">
            <input type="radio" name="constraints" value="None" required class="sr-only peer" />
            <div class="w-4 h-4 rounded-full border border-white/20 peer-checked:bg-accent peer-checked:border-accent flex-shrink-0"></div>
            <span class="text-sm text-muted group-hover:text-text">None</span>
          </label>
          <label class="flex flex-col gap-2 p-4 bg-bg border border-white/10 rounded-lg cursor-pointer hover:border-accent/50 transition-colors group">
            <div class="flex items-center gap-3">
              <input type="radio" name="constraints" value="Past Injury (Not Limiting)" class="sr-only peer" id="constraints_past_injury_radio" />
              <div class="w-4 h-4 rounded-full border border-white/20 peer-checked:bg-accent peer-checked:border-accent flex-shrink-0"></div>
              <span class="text-sm text-muted group-hover:text-text">Past Injury (Not Limiting)</span>
            </div>
            <input type="text" name="constraints_past_injury_detail" id="constraints_past_injury_field" placeholder="Describe briefly..." class="hidden bg-bg border border-white/10 rounded-lg px-3 py-2 text-sm text-text focus:outline-none focus:border-accent transition-colors mt-2" />
          </label>
          <label class="flex flex-col gap-2 p-4 bg-bg border border-white/10 rounded-lg cursor-pointer hover:border-accent/50 transition-colors group">
            <div class="flex items-center gap-3">
              <input type="radio" name="constraints" value="Current Issue (Limits Training)" class="sr-only peer" id="constraints_current_issue_radio" />
              <div class="w-4 h-4 rounded-full border border-white/20 peer-checked:bg-accent peer-checked:border-accent flex-shrink-0"></div>
              <span class="text-sm text-muted group-hover:text-text">Current Issue (Limits Training)</span>
            </div>
            <input type="text" name="constraints_current_issue_detail" id="constraints_current_issue_field" placeholder="Describe briefly..." class="hidden bg-bg border border-white/10 rounded-lg px-3 py-2 text-sm text-text focus:outline-none focus:border-accent transition-colors mt-2" />
          </label>
          <label class="flex items-center gap-3 p-4 bg-bg border border-white/10 rounded-lg cursor-pointer hover:border-accent/50 transition-colors group">
            <input type="radio" name="constraints" value="Prefer not to say" class="sr-only peer" />
            <div class="w-4 h-4 rounded-full border border-white/20 peer-checked:bg-accent peer-checked:border-accent flex-shrink-0"></div>
            <span class="text-sm text-muted group-hover:text-text">Prefer not to say</span>
          </label>
        </div>
        <p class="text-[11px] text-muted leading-relaxed">This is not medical advice, it helps tailor recommendations.</p>
      </div>
    </div>

    <!-- Step 5: Optional Upload Decision -->
    <div data-step="5" class="space-y-6 hidden">
      <div class="space-y-4">
        <label class="block text-xs font-bold text-accent uppercase tracking-widest">Want a Deeper Audit by Uploading Your Stats? *</label>
        <div class="grid grid-cols-1 gap-3">
          <label class="flex items-center gap-3 p-4 bg-bg border border-white/10 rounded-lg cursor-pointer hover:border-accent/50 transition-colors group">
            <input type="radio" name="wants_upload" value="Yes" required class="sr-only peer" />
            <div class="w-4 h-4 rounded-full border border-white/20 peer-checked:bg-accent peer-checked:border-accent flex-shrink-0"></div>
            <span class="text-sm text-muted group-hover:text-text">Yes, I Will Upload (Recommended)</span>
          </label>
          <label class="flex items-center gap-3 p-4 bg-bg border border-white/10 rounded-lg cursor-pointer hover:border-accent/50 transition-colors group">
            <input type="radio" name="wants_upload" value="No" class="sr-only peer" />
            <div class="w-4 h-4 rounded-full border border-white/20 peer-checked:bg-accent peer-checked:border-accent flex-shrink-0"></div>
            <span class="text-sm text-muted group-hover:text-text">No, Just Use My Answers</span>
          </label>
        </div>
      </div>

      <div class="space-y-4 pt-4 border-t border-white/5">
        <label class="flex items-center gap-3 cursor-pointer group">
          <input type="checkbox" name="consent" required class="sr-only peer" />
          <div class="w-5 h-5 border border-white/20 rounded peer-checked:bg-accent peer-checked:border-accent flex items-center justify-center transition-colors">
            <svg class="w-3.5 h-3.5 text-bg hidden peer-checked:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
          </div>
          <span class="text-sm text-muted group-hover:text-text">I consent to the processing of my data to receive the performance audit. *</span>
        </label>
        <p class="text-[11px] text-muted leading-relaxed">This is coaching guidance, not medical advice. If you have medical concerns, consult your GP or clinician.</p>
      </div>
    </div>

    <!-- Sticky Mobile Footer / Action Bar -->
    <div class="fixed bottom-0 left-0 right-0 p-4 bg-bg/95 backdrop-blur-md border-t border-white/5 sm:relative sm:bg-transparent sm:border-none sm:p-0 flex items-center justify-between gap-4 z-20">
      <button type="button" id="prev-btn" class="hidden px-6 py-3 rounded-lg text-sm font-bold text-muted hover:text-text hover:bg-white/5 transition-all">Back</button>
      <div class="flex-grow"></div>
      <button type="button" id="next-btn" class="px-8 py-3 bg-accent text-bg rounded-lg text-sm font-bold hover:brightness-110 transition-all">Continue</button>
      <button type="submit" id="submit-btn" class="hidden px-8 py-3 bg-accent text-bg rounded-lg text-sm font-bold hover:brightness-110 transition-all">Get My Audit</button>
    </div>

    <!-- Error State -->
    <div id="form-error" class="hidden p-4 bg-red-500/10 border border-red-500/20 rounded-lg text-red-500 text-sm text-center">
      Something went wrong. Please try again.
    </div>
  </form>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="hidden absolute inset-0 bg-bg/80 backdrop-blur-sm z-30 flex items-center justify-center">
    <div class="text-center">
      <div class="w-10 h-10 border-2 border-accent border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-xs font-bold text-accent uppercase tracking-widest">Submitting your audit...</p>
    </div>
  </div>

  <!-- Success State (shown after submit) -->
  <div id="success-state" class="hidden p-6 sm:p-10 space-y-8">
    <div class="text-center">
      <div class="w-16 h-16 mx-auto bg-accent/10 border border-accent/20 rounded-full flex items-center justify-center mb-6">
        <svg class="w-8 h-8 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      </div>
      <h2 class="text-2xl font-bold text-text mb-4">Thanks, Your Audit Is Received.</h2>
      <p class="text-muted leading-relaxed">
        Reply within <strong class="text-text">24 hours (business days)</strong>.
      </p>
    </div>

    <!-- Inline Upload Panel (only if wants_upload=Yes) -->
    <div id="inline-upload-panel" data-upload-panel="1" data-native-upload="1" class="hidden border border-accent/20 rounded-xl bg-accent/5 p-6 space-y-4">
      <h3 class="text-lg font-bold text-text">Optional: Upload Your 30-Day Summary</h3>
      <ul class="text-sm text-muted space-y-1 list-disc list-inside">
        <li>Screenshots or exports are fine.</li>
        <li>Accepted formats: PDF, JPG/PNG, CSV.</li>
        <li>Examples: Apple Health, Garmin, Strava, WHOOP, Oura, Fitbit.</li>
        <li>Please do not upload medical documents.</li>
      </ul>
      
      <!-- Native file input -->
      <div id="upload-dropzone" class="border-2 border-dashed border-white/20 rounded-lg p-6 text-center hover:border-accent/50 transition-colors cursor-pointer">
        <input type="file" id="upload-file-input" accept=".pdf,.jpg,.jpeg,.png,.csv" class="hidden" />
        <div id="upload-dropzone-content">
          <svg class="w-10 h-10 mx-auto mb-3 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          <p class="text-sm text-muted mb-2">Drag and drop your file here, or</p>
          <span class="text-sm text-accent underline">click to browse</span>
        </div>
        <div id="upload-file-selected" class="hidden">
          <p class="text-sm text-text font-medium" id="selected-file-name"></p>
          <p class="text-xs text-muted" id="selected-file-size"></p>
        </div>
      </div>
      
      <!-- Progress bar -->
      <div id="upload-progress-container" class="hidden">
        <div class="h-2 bg-white/10 rounded-full overflow-hidden">
          <div id="upload-progress-bar" class="h-full bg-accent transition-all duration-300" style="width: 0%"></div>
        </div>
        <p class="text-xs text-muted mt-1" id="upload-progress-text">Uploading...</p>
      </div>
      
      <!-- Consent checkbox -->
      <label class="flex items-start gap-3 cursor-pointer group">
        <input type="checkbox" id="upload-consent" class="sr-only peer" />
        <div class="w-5 h-5 mt-0.5 border border-white/20 rounded peer-checked:bg-accent peer-checked:border-accent flex items-center justify-center transition-colors flex-shrink-0">
          <svg class="w-3.5 h-3.5 text-bg hidden peer-checked:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
        </div>
        <span class="text-sm text-muted group-hover:text-text">I consent to you processing this file to produce my Performance Audit and contacting me about it.</span>
      </label>
      
      <!-- Upload error message -->
      <div id="upload-error" class="hidden p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm"></div>
      
      <!-- Upload success message -->
      <div id="upload-success" class="hidden p-3 bg-green-500/10 border border-green-500/20 rounded-lg text-green-400 text-sm">
        Upload received. I will include it in your audit.
      </div>
      
      <!-- Buttons -->
      <div class="flex items-center gap-4 pt-2">
        <button type="button" id="upload-submit-btn" class="px-6 py-3 bg-accent text-bg rounded-lg text-sm font-bold hover:brightness-110 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          Upload File
        </button>
        <button type="button" id="skip-upload-btn" class="text-sm text-muted hover:text-accent underline transition-colors">
          Skip for Now
        </button>
      </div>
    </div>

    <!-- After upload skipped or not needed -->
    <div id="upload-skipped-msg" class="hidden text-center text-sm text-muted">
      <p>Your audit will proceed using your quiz answers. Check your inbox!</p>
    </div>

    <div class="text-center pt-4">
      <a href="/" class="text-xs text-muted hover:text-accent uppercase tracking-widest font-mono transition-colors">
        ← Back to Home
      </a>
    </div>
  </div>
</div>

<script is:inline>
  (() => {
    const form = document.getElementById('lead-form');
    const progressBar = document.getElementById('progress-bar');
    const nextBtn = document.getElementById('next-btn');
    const prevBtn = document.getElementById('prev-btn');
    const submitBtn = document.getElementById('submit-btn');
    const errorMsg = document.getElementById('form-error');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    let currentStep = 1;
    const totalSteps = 5;

    // "Other" reveal logic
    function setupOtherReveal(radioName, textFieldId) {
      const radios = document.querySelectorAll(`input[name="${radioName}"]`);
      const textField = document.getElementById(textFieldId);
      
      radios.forEach(radio => {
        radio.addEventListener('change', () => {
          if (radio.value === 'Other' && radio.checked) {
            textField.classList.remove('hidden');
            textField.required = true;
          } else if (radio.checked) {
            textField.classList.add('hidden');
            textField.required = false;
            textField.value = '';
          }
        });
      });
    }

    // Initialize Other reveal for main_goal and biggest_blocker
    setupOtherReveal('main_goal', 'main_goal_other_field');
    setupOtherReveal('biggest_blocker', 'biggest_blocker_other_field');

    // Constraints reveal logic (for Past Injury and Current Issue)
    function setupConstraintsReveal() {
      const radios = document.querySelectorAll('input[name="constraints"]');
      const pastInjuryField = document.getElementById('constraints_past_injury_field');
      const currentIssueField = document.getElementById('constraints_current_issue_field');
      
      radios.forEach(radio => {
        radio.addEventListener('change', () => {
          // Hide both fields first
          pastInjuryField.classList.add('hidden');
          pastInjuryField.required = false;
          currentIssueField.classList.add('hidden');
          currentIssueField.required = false;
          
          // Show the relevant field
          if (radio.value === 'Past Injury (Not Limiting)' && radio.checked) {
            pastInjuryField.classList.remove('hidden');
            pastInjuryField.required = true;
          } else if (radio.value === 'Current Issue (Limits Training)' && radio.checked) {
            currentIssueField.classList.remove('hidden');
            currentIssueField.required = true;
          }
        });
      });
    }
    setupConstraintsReveal();

    function updateUI() {
      // Show/Hide steps
      document.querySelectorAll('[data-step]').forEach(el => {
        el.classList.toggle('hidden', parseInt(el.dataset.step) !== currentStep);
      });

      // Update progress
      progressBar.style.width = `${(currentStep / totalSteps) * 100}%`;

      // Update buttons
      prevBtn.classList.toggle('hidden', currentStep === 1);
      nextBtn.classList.toggle('hidden', currentStep === totalSteps);
      submitBtn.classList.toggle('hidden', currentStep !== totalSteps);
      
      // Scroll to top of wizard on mobile
      if (window.innerWidth < 640) {
        document.getElementById('quiz-wizard').scrollIntoView({ behavior: 'smooth' });
      }
    }

    function validateStep(step) {
      const stepEl = document.querySelector(`[data-step="${step}"]`);
      const inputs = stepEl.querySelectorAll('input[required], select[required]');
      
      let isValid = true;
      let firstInvalid = null;

      inputs.forEach(input => {
        if (input.type === 'radio') {
          const groupName = input.name;
          const checked = stepEl.querySelector(`input[name="${groupName}"]:checked`);
          if (!checked) {
            isValid = false;
            if (!firstInvalid) firstInvalid = input.parentElement;
          }
        } else if (input.type === 'checkbox') {
          if (!input.checked) {
            isValid = false;
            if (!firstInvalid) firstInvalid = input.parentElement;
          }
        } else {
          if (!input.value.trim()) {
            isValid = false;
            if (!firstInvalid) firstInvalid = input;
          }
        }
      });

      if (!isValid && firstInvalid) {
        firstInvalid.focus?.();
        firstInvalid.classList.add('border-red-500/50');
        setTimeout(() => firstInvalid.classList.remove('border-red-500/50'), 2000);
      }

      return isValid;
    }

    nextBtn.addEventListener('click', () => {
      if (validateStep(currentStep)) {
        currentStep++;
        updateUI();
      }
    });

    prevBtn.addEventListener('click', () => {
      currentStep--;
      updateUI();
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!validateStep(currentStep)) return;

      errorMsg.classList.add('hidden');
      loadingOverlay.classList.remove('hidden');

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      
      // Handle "Other" values
      if (data.main_goal === 'Other') {
        data.main_goal = `Other: ${data.main_goal_other || ''}`;
      }
      if (data.biggest_blocker === 'Other') {
        data.biggest_blocker = `Other: ${data.biggest_blocker_other || ''}`;
      }
      
      // Handle constraints details
      if (data.constraints === 'Past Injury (Not Limiting)' && data.constraints_past_injury_detail) {
        data.constraints = `Past Injury (Not Limiting): ${data.constraints_past_injury_detail}`;
      }
      if (data.constraints === 'Current Issue (Limits Training)' && data.constraints_current_issue_detail) {
        data.constraints = `Current Issue (Limits Training): ${data.constraints_current_issue_detail}`;
      }
      
      delete data.main_goal_other;
      delete data.biggest_blocker_other;
      delete data.constraints_past_injury_detail;
      delete data.constraints_current_issue_detail;

      try {
        const response = await fetch('/api/lead', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.ok) {
          // Hide form, show success state
          loadingOverlay.classList.add('hidden');
          form.classList.add('hidden');
          
          const successState = document.getElementById('success-state');
          const uploadPanel = document.getElementById('inline-upload-panel');
          const uploadSkippedMsg = document.getElementById('upload-skipped-msg');
          const skipBtn = document.getElementById('skip-upload-btn');
          
          // Store email and leadId for upload
          window.__quizData = {
            email: data.email,
            leadId: result.leadId || ''
          };
          
          successState.classList.remove('hidden');
          
          // If user selected upload=Yes, show the native upload panel
          if (data.wants_upload === 'Yes') {
            uploadPanel.classList.remove('hidden');
            initNativeUpload();
          } else {
            // User selected No upload
            uploadSkippedMsg.classList.remove('hidden');
          }
          
          // Handle skip button
          if (skipBtn) {
            skipBtn.addEventListener('click', () => {
              uploadPanel.classList.add('hidden');
              uploadSkippedMsg.classList.remove('hidden');
            });
          }
          
          // Scroll to top
          document.getElementById('quiz-wizard').scrollIntoView({ behavior: 'smooth' });
          
        } else {
          throw new Error(result.error || 'Submission failed');
        }
      } catch (err) {
        console.error('Quiz Submission Error:', err);
        loadingOverlay.classList.add('hidden');
        errorMsg.classList.remove('hidden');
        errorMsg.textContent = err.message || 'Something went wrong. Please try again.';
      }
    });
    
    // Native Upload Handler
    function initNativeUpload() {
      const dropzone = document.getElementById('upload-dropzone');
      const fileInput = document.getElementById('upload-file-input');
      const dropzoneContent = document.getElementById('upload-dropzone-content');
      const fileSelected = document.getElementById('upload-file-selected');
      const selectedFileName = document.getElementById('selected-file-name');
      const selectedFileSize = document.getElementById('selected-file-size');
      const consent = document.getElementById('upload-consent');
      const uploadBtn = document.getElementById('upload-submit-btn');
      const progressContainer = document.getElementById('upload-progress-container');
      const progressBar = document.getElementById('upload-progress-bar');
      const progressText = document.getElementById('upload-progress-text');
      const uploadError = document.getElementById('upload-error');
      const uploadSuccess = document.getElementById('upload-success');
      const skipBtn = document.getElementById('skip-upload-btn');
      const uploadPanel = document.getElementById('inline-upload-panel');
      const uploadSkippedMsg = document.getElementById('upload-skipped-msg');
      
      let selectedFile = null;
      
      // Click to browse
      dropzone.addEventListener('click', () => fileInput.click());
      
      // Drag and drop
      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('border-accent');
      });
      dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('border-accent');
      });
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('border-accent');
        if (e.dataTransfer.files.length) {
          handleFileSelect(e.dataTransfer.files[0]);
        }
      });
      
      // File input change
      fileInput.addEventListener('change', () => {
        if (fileInput.files.length) {
          handleFileSelect(fileInput.files[0]);
        }
      });
      
      function handleFileSelect(file) {
        selectedFile = file;
        dropzoneContent.classList.add('hidden');
        fileSelected.classList.remove('hidden');
        selectedFileName.textContent = file.name;
        selectedFileSize.textContent = formatFileSize(file.size);
        updateUploadBtnState();
      }
      
      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }
      
      // Consent checkbox
      consent.addEventListener('change', updateUploadBtnState);
      
      function updateUploadBtnState() {
        uploadBtn.disabled = !(selectedFile && consent.checked);
      }
      
      // Upload button
      uploadBtn.addEventListener('click', async () => {
        if (!selectedFile || !consent.checked) return;
        
        uploadError.classList.add('hidden');
        uploadBtn.disabled = true;
        progressContainer.classList.remove('hidden');
        progressBar.style.width = '0%';
        
        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('email', window.__quizData.email || '');
        formData.append('leadId', window.__quizData.leadId || '');
        formData.append('consent', 'true');
        
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const pct = Math.round((e.loaded / e.total) * 100);
            progressBar.style.width = pct + '%';
            progressText.textContent = `Uploading... ${pct}%`;
          }
        });
        
        xhr.addEventListener('load', () => {
          progressContainer.classList.add('hidden');
          try {
            const result = JSON.parse(xhr.responseText);
            if (xhr.status === 200 && result.ok) {
              uploadSuccess.classList.remove('hidden');
              // Hide all upload UI elements, keeping only success message
              dropzone.classList.add('hidden');
              document.querySelector('label:has(#upload-consent)').classList.add('hidden');
              uploadBtn.classList.add('hidden');
              skipBtn.classList.add('hidden');
              // Also hide the header and instructions
              document.querySelector('#inline-upload-panel h3').classList.add('hidden');
              document.querySelector('#inline-upload-panel ul').classList.add('hidden');
            } else {
              uploadError.textContent = result.error || 'Upload failed. Please try again.';
              uploadError.classList.remove('hidden');
              uploadBtn.disabled = false;
            }
          } catch (e) {
            uploadError.textContent = 'Upload failed. Please try again.';
            uploadError.classList.remove('hidden');
            uploadBtn.disabled = false;
          }
        });
        
        xhr.addEventListener('error', () => {
          progressContainer.classList.add('hidden');
          uploadError.textContent = 'Network error. Please check your connection and try again.';
          uploadError.classList.remove('hidden');
          uploadBtn.disabled = false;
        });
        
        xhr.open('POST', '/api/upload');
        xhr.send(formData);
      });
    }
  })();
</script>

<style>
  /* Prevent scrolling on mobile when sticky footer is active */
  @media (max-width: 640px) {
    #quiz-wizard {
      padding-bottom: 80px;
    }
  }
</style>
