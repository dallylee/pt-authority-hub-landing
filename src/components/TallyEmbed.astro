---
interface Props {
  formId?: string;
  title: string;
  height?: number;
  description?: string;
}

const { formId, title, height = 700, description } = Astro.props;
---

<div class="tally-embed-container">
  {description && <p class="text-muted2 text-[10px] uppercase tracking-widest mb-6 font-mono italic">{description}</p>}
  
  {!formId ? (
    <!-- Placeholder state when form ID is not configured -->
    <div class="bg-bg2/50 border border-white/5 rounded-lg p-12 text-center">
      <div class="max-w-md mx-auto">
        <svg class="w-12 h-12 mx-auto mb-6 text-muted2 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <h3 class="text-sm font-bold text-muted uppercase tracking-widest mb-4">Signal Interface Offline</h3>
        <p class="text-xs text-muted2 mb-8 lowercase font-mono">
          Waiting for configuration synchronization...
        </p>
        <div class="bg-panel border border-white/5 rounded p-5 text-left">
          <p class="text-[10px] text-accent uppercase tracking-widest mb-3 font-bold">Initialization Required:</p>
          <ul class="text-[10px] text-muted2 space-y-2 uppercase tracking-tight font-mono">
            <li>1. Sync .env with protocol template</li>
            <li>2. Map Tally ID to integration layer</li>
            <li>3. Deploy update</li>
          </ul>
        </div>
      </div>
    </div>
  ) : (
    <!-- Tally embed when form ID is configured -->
    <div 
      class="tally-embed-wrapper bg-panel rounded-lg overflow-hidden border border-white/5"
      data-tally-form-id={formId}
      data-tally-height={height}
      style={`min-height: ${height}px;`}
    >
      <div class="flex items-center justify-center bg-panel" style={`height: ${height}px;`}>
        <div class="text-center">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-accent mb-4"></div>
          <p class="text-muted2 text-xs uppercase tracking-widest font-mono">Synchronizing...</p>
        </div>
      </div>
    </div>
  )}
</div>

{formId && (
  <script define:vars={{ formId, height }}>
    // Lazy-load Tally embed only when container is near viewport
    function initTallyEmbed() {
      const container = document.querySelector(`[data-tally-form-id="${formId}"]`);
      if (!container) return;

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            loadTallyScript();
            observer.disconnect();
          }
        });
      }, {
        rootMargin: '200px' // Start loading 200px before element enters viewport
      });

      observer.observe(container);
    }

    function loadTallyScript() {
      // Check if Tally script is already loaded
      if (window.Tally) {
        embedTallyForm();
        return;
      }

      // Load Tally embed script
      const script = document.createElement('script');
      script.src = 'https://tally.so/widgets/embed.js';
      script.defer = true;
      script.onload = () => {
        embedTallyForm();
      };
      document.head.appendChild(script);
    }

    function embedTallyForm() {
      const container = document.querySelector(`[data-tally-form-id="${formId}"]`);
      if (!container || !window.Tally) return;

      // Clear loading state
      container.innerHTML = '';

      // Create iframe container
      const iframeContainer = document.createElement('div');
      iframeContainer.setAttribute('data-tally-src', `https://tally.so/r/${formId}`);
      iframeContainer.style.width = '100%';
      iframeContainer.style.height = `${height}px`;
      container.appendChild(iframeContainer);

      // Initialize Tally
      if (window.Tally.loadEmbeds) {
        window.Tally.loadEmbeds();
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTallyEmbed);
    } else {
      initTallyEmbed();
    }
  </script>
)}

<style>
  .tally-embed-container {
    @apply w-full;
  }

  .tally-embed-wrapper {
    @apply relative;
  }

  /* Animation for loading spinner */
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }
</style>
