---
interface Props {
  formId?: string;
  title: string;
  height?: number;
  description?: string;
}

const { formId, title, height = 700, description } = Astro.props;
---

<div class="tally-embed-container">
  <h2 class="text-2xl font-bold mb-4">{title}</h2>
  {description && <p class="text-gray-600 mb-6">{description}</p>}
  
  {!formId ? (
    <!-- Placeholder state when form ID is not configured -->
    <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-12 text-center">
      <div class="max-w-md mx-auto">
        <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <h3 class="text-lg font-semibold text-gray-700 mb-2">Form Not Configured Yet</h3>
        <p class="text-sm text-gray-600 mb-4">
          This form will appear once configured.
        </p>
        <div class="bg-blue-50 border border-blue-200 rounded p-4 text-left">
          <p class="text-xs text-gray-700 mb-2"><strong>To configure:</strong></p>
          <ol class="text-xs text-gray-600 space-y-1 list-decimal list-inside">
            <li>Create a <code class="bg-white px-1 rounded">.env</code> file in the project root</li>
            <li>Copy settings from <code class="bg-white px-1 rounded">.env.example</code></li>
            <li>Add your Tally form ID</li>
          </ol>
        </div>
      </div>
    </div>
  ) : (
    <!-- Tally embed when form ID is configured -->
    <div 
      class="tally-embed-wrapper bg-white rounded-lg shadow-lg overflow-hidden"
      data-tally-form-id={formId}
      data-tally-height={height}
      style={`min-height: ${height}px;`}
    >
      <div class="flex items-center justify-center bg-gray-50" style={`height: ${height}px;`}>
        <div class="text-center">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"></div>
          <p class="text-gray-600">Loading form...</p>
        </div>
      </div>
    </div>
  )}
</div>

{formId && (
  <script define:vars={{ formId, height }}>
    // Lazy-load Tally embed only when container is near viewport
    function initTallyEmbed() {
      const container = document.querySelector(`[data-tally-form-id="${formId}"]`);
      if (!container) return;

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            loadTallyScript();
            observer.disconnect();
          }
        });
      }, {
        rootMargin: '200px' // Start loading 200px before element enters viewport
      });

      observer.observe(container);
    }

    function loadTallyScript() {
      // Check if Tally script is already loaded
      if (window.Tally) {
        embedTallyForm();
        return;
      }

      // Load Tally embed script
      const script = document.createElement('script');
      script.src = 'https://tally.so/widgets/embed.js';
      script.defer = true;
      script.onload = () => {
        embedTallyForm();
      };
      document.head.appendChild(script);
    }

    function embedTallyForm() {
      const container = document.querySelector(`[data-tally-form-id="${formId}"]`);
      if (!container || !window.Tally) return;

      // Clear loading state
      container.innerHTML = '';

      // Create iframe container
      const iframeContainer = document.createElement('div');
      iframeContainer.setAttribute('data-tally-src', `https://tally.so/r/${formId}`);
      iframeContainer.style.width = '100%';
      iframeContainer.style.height = `${height}px`;
      container.appendChild(iframeContainer);

      // Initialize Tally
      if (window.Tally.loadEmbeds) {
        window.Tally.loadEmbeds();
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTallyEmbed);
    } else {
      initTallyEmbed();
    }
  </script>
)}

<style>
  .tally-embed-container {
    @apply w-full;
  }

  .tally-embed-wrapper {
    @apply relative;
  }

  /* Animation for loading spinner */
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }
</style>
