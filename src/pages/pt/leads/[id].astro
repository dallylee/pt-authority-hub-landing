---
import AnalyticsPlausible from '../../../components/AnalyticsPlausible.astro';

// Enable SSR for this page so it can be generated dynamically
export const prerender = false;

const { id } = Astro.params;
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lead Detail - PT Console</title>
  <AnalyticsPlausible />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e5e5e5;
      min-height: 100vh;
    }
    nav {
      background: #1a1a1a;
      border-bottom: 1px solid #2a2a2a;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav h1 {
      font-size: 18px;
      color: #00ff88;
    }
    nav a {
      color: #888;
      text-decoration: none;
      font-size: 13px;
    }
    nav a:hover {
      color: #00ff88;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }
    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }
    .card {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 24px;
    }
    h2 {
      font-size: 18px;
      margin-bottom: 16px;
      color: #fff;
    }
    .field {
      margin-bottom: 16px;
    }
    .field label {
      display: block;
      font-size: 12px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .field .value {
      font-size: 14px;
      color: #ccc;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge.hot { background: rgba(255, 68, 68, 0.2); color: #ff4444; }
    .badge.warm { background: rgba(255, 184, 0, 0.2); color: #ffb800; }
    .badge.nurture { background: rgba(0, 136, 255, 0.2); color: #0088ff; }
    textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      background: #0a0a0a;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
      color: #ccc;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
    }
    select {
      width: 100%;
      padding: 8px 12px;
      background: #0a0a0a;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
      color: #ccc;
      font-size: 14px;
    }
    button {
      padding: 10px 20px;
      background: #00ff88;
      color: #0a0a0a;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover {
      background: #00dd77;
    }
    .empty {
      text-align: center;
      padding: 48px;
      color: #666;
    }
  </style>
</head>
<body>
  <nav>
    <h1>PT Console</h1>
    <a href="/pt">← Back to Inbox</a>
  </nav>

  <div class="container">
    <div class="grid">
      <div>
        <div class="card">
          <h2>Lead Information</h2>
          <div id="lead-info" class="empty">Loading lead details...</div>
        </div>

        <div class="card" style="margin-top: 24px;">
          <h2>Quiz Answers</h2>
          <div id="quiz-answers" class="empty">Loading answers...</div>
        </div>
      </div>

      <div>
        <div class="card">
          <h2>Triage & Scoring</h2>
          <div id="triage-info" class="empty">Loading...</div>
        </div>

        <div class="card" style="margin-top: 24px;">
          <h2>Internal Notes</h2>
          <div class="field">
            <label>Notes</label>
            <textarea id="notes-field" placeholder="Add internal notes..."></textarea>
          </div>
          <div class="field">
            <label>Status</label>
            <select id="status-field">
              <option value="NEW">New</option>
              <option value="IN_REVIEW">In Review</option>
              <option value="CLOSED">Closed</option>
            </select>
          </div>
          <button onclick="saveNotes()">Save Notes</button>
        </div>

        <div class="card" style="margin-top: 24px;">
          <h2>Uploads</h2>
          <div id="uploads-list" class="empty">No uploads</div>
        </div>

        <div class="card" style="margin-top: 24px;">
          <h2>Send Analysis</h2>
          <div id="analysis-sent-status" style="margin-bottom:12px; font-size:12px; color:#666;"></div>
          <div class="field">
            <label>Analysis Draft</label>
            <textarea id="analysis-draft" placeholder="Write your analysis here... The bottleneck and reasons above can help guide your insights." style="min-height:150px;"></textarea>
          </div>
          <div style="display:flex; gap:12px; margin-top:12px;">
            <button onclick="generateDraft()" style="background:#2a2a2a; color:#ccc;">Generate Template</button>
            <button onclick="sendAnalysis()">Send to Client</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script define:vars={{ id }}>
    const leadId = id;
    
    function esc(s) {
      return String(s ?? '').replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      try {
        return new Date(dateStr).toLocaleString();
      } catch {
        return dateStr;
      }
    }

    function getBadgeClass(segment) {
      switch (segment?.toUpperCase()) {
        case 'HOT': return 'badge hot';
        case 'WARM': return 'badge warm';
        case 'NURTURE': return 'badge nurture';
        case 'DISQUALIFIED': return 'badge disqualified';
        default: return 'badge';
      }
    }

    async function loadLead() {
      try {
        const res = await fetch(`/api/pt/leads/${encodeURIComponent(leadId)}`, {
          headers: { 'Accept': 'application/json' }
        });
        const data = await res.json();

        if (!res.ok || !data.ok) {
          document.getElementById('lead-info').innerHTML = `<div class="empty">Error: ${esc(data.error || 'Failed to load lead')}</div>`;
          return;
        }

        const lead = data.lead;
        const uploads = data.uploads || [];
        
        // Store lead globally for template generation
        currentLead = lead;
        
        // Load existing analysis draft if present
        if (lead.analysis_draft) {
          document.getElementById('analysis-draft').value = lead.analysis_draft;
        }
        if (lead.analysis_sent_at) {
          document.getElementById('analysis-sent-status').innerHTML = 
            `<span style="color:#00ff88;">✓ Last sent: ${formatDate(lead.analysis_sent_at)}</span>`;
        }

        // Render lead info
        document.getElementById('lead-info').innerHTML = `
          <div class="field"><label>Email</label><div class="value">${esc(lead.client_email || lead.email)}</div></div>
          <div class="field"><label>Name</label><div class="value">${esc(lead.client_first_name || lead.first_name || 'N/A')}</div></div>
          <div class="field"><label>Location</label><div class="value">${esc(lead.client_location || lead.location || 'N/A')}</div></div>
          <div class="field"><label>Submitted</label><div class="value">${formatDate(lead.created_at)}</div></div>
          <div class="field"><label>Goal</label><div class="value">${esc(lead.goal || lead.main_goal || 'N/A')}</div></div>
          <div class="field"><label>Start Timeline</label><div class="value">${esc(lead.start_timeline || lead.start_timing || 'N/A')}</div></div>
          <div class="field"><label>Coaching Preference</label><div class="value">${esc(lead.coaching_preference || 'N/A')}</div></div>
        `;

        // Render triage info
        const segment = lead.triage_segment || 'UNKNOWN';
        const score = lead.triage_score ?? 'N/A';
        const bottleneck = lead.inferred_bottleneck || 'ASSESSMENT_NEEDED';
        const confidence = lead.inferred_confidence || 'N/A';
        
        // Parse reasons and breakdown if available
        let reasons = [];
        let breakdown = {};
        try {
          if (lead.bottleneck_reasons) reasons = JSON.parse(lead.bottleneck_reasons);
          if (lead.bottleneck_breakdown) breakdown = JSON.parse(lead.bottleneck_breakdown);
        } catch (e) {}
        
        let reasonsHtml = '';
        if (reasons.length > 0) {
          reasonsHtml = `
            <div class="field" style="margin-top:12px;">
              <label>Why This Bottleneck</label>
              <ul style="margin:4px 0 0 16px; padding:0; font-size:13px; color:#aaa;">
                ${reasons.map(r => `<li style="margin-bottom:4px;">${esc(r)}</li>`).join('')}
              </ul>
            </div>
          `;
        }
        
        let breakdownHtml = '';
        if (Object.keys(breakdown).length > 0) {
          const sorted = Object.entries(breakdown).sort((a, b) => Number(b[1]) - Number(a[1]));
          breakdownHtml = `
            <details style="margin-top:12px; cursor:pointer;">
              <summary style="font-size:11px; color:#888; text-transform:uppercase; letter-spacing:0.5px;">Domain Scores</summary>
              <div style="margin-top:8px;">
                ${sorted.map(([k, v]) => `
                  <div style="display:flex; justify-content:space-between; font-size:12px; color:#666; margin-bottom:4px;">
                    <span>${esc(k)}</span>
                    <span style="color:${Number(v) > 0 ? '#00ff88' : '#444'}">${v}</span>
                  </div>
                `).join('')}
              </div>
            </details>
          `;
        }
        
        document.getElementById('triage-info').innerHTML = `
          <div class="field"><label>Segment</label><div class="value"><span class="${getBadgeClass(segment)}">${esc(segment)}</span></div></div>
          <div class="field"><label>Score</label><div class="value">${esc(score)}</div></div>
          <div class="field"><label>Bottleneck</label><div class="value"><strong>${esc(bottleneck)}</strong> <span style="color:#666;">(${esc(confidence)} confidence)</span></div></div>
          ${reasonsHtml}
          ${breakdownHtml}
          <div class="field" style="margin-top:12px;"><label>Fit Risk</label><div class="value">${lead.fit_risk ? 'Yes' : 'No'}</div></div>
        `;

        // Render quiz answers
        let answersHtml = '';
        try {
          const answers = lead.answers_raw_json ? JSON.parse(lead.answers_raw_json) : {};
          for (const [key, value] of Object.entries(answers)) {
            if (key !== 'company' && key !== 'consent') {
              answersHtml += `<div class="field"><label>${esc(key.replace(/_/g, ' '))}</label><div class="value">${esc(value)}</div></div>`;
            }
          }
        } catch {
          answersHtml = `
            <div class="field"><label>Biggest Blocker</label><div class="value">${esc(lead.biggest_blocker || 'N/A')}</div></div>
            <div class="field"><label>Training Days/Week</label><div class="value">${esc(lead.training_days_now || 'N/A')}</div></div>
            <div class="field"><label>Time Commitment</label><div class="value">${esc(lead.time_commitment_weekly || 'N/A')}</div></div>
            <div class="field"><label>Monthly Budget</label><div class="value">${esc(lead.budget_monthly || 'N/A')}</div></div>
            <div class="field"><label>Constraints</label><div class="value">${esc(lead.injury_notes || (lead.injury_flag ? 'Has constraints' : 'None'))}</div></div>
            <div class="field"><label>Wants Upload</label><div class="value">${lead.wants_upload_stats ? 'Yes' : 'No'}</div></div>
          `;
        }
        document.getElementById('quiz-answers').innerHTML = answersHtml || '<div class="empty">No answers recorded</div>';

        // Load existing notes and status
        document.getElementById('notes-field').value = lead.internal_notes || '';
        document.getElementById('status-field').value = lead.status || 'NEW';

        // Render uploads
        if (uploads.length > 0) {
          document.getElementById('uploads-list').innerHTML = uploads.map(u => `
            <div class="field">
              <label>${formatDate(u.created_at)}</label>
              <div class="value">
                <strong>${esc(u.file_name)}</strong>
                <span style="color:#666; font-size:12px;"> (${(u.file_size_bytes / 1024).toFixed(1)} KB)</span>
              </div>
            </div>
          `).join('');
        } else {
          document.getElementById('uploads-list').innerHTML = '<div class="empty">No uploads</div>';
        }

      } catch (err) {
        console.error('Load lead error:', err);
        document.getElementById('lead-info').innerHTML = `<div class="empty">Failed to load lead data</div>`;
      }
    }

    // Store lead data globally for template generation
    let currentLead = null;

    async function saveNotes() {
      const notes = document.getElementById('notes-field').value;
      const status = document.getElementById('status-field').value;

      try {
        const res = await fetch(`/api/pt/leads/${encodeURIComponent(leadId)}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ notes, status })
        });
        const data = await res.json();
        
        if (data.ok) {
          alert('Notes saved!');
        } else {
          alert('Failed to save: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Failed to save notes');
      }
    }

    function generateDraft() {
      if (!currentLead) {
        alert('Lead data not loaded yet');
        return;
      }

      const name = currentLead.client_first_name || 'there';
      const bottleneck = currentLead.inferred_bottleneck || 'your training';
      const segment = currentLead.triage_segment || '';
      
      let reasons = [];
      try {
        if (currentLead.bottleneck_reasons) reasons = JSON.parse(currentLead.bottleneck_reasons);
      } catch (e) {}

      const bottleneckLabels = {
        'TRAINING': 'programming and exercise selection',
        'CONSISTENCY': 'building sustainable habits and consistency',
        'NUTRITION': 'nutrition strategy and dietary approach',
        'RECOVERY': 'recovery, stress management, and energy optimisation',
        'INJURY_CONSTRAINTS': 'working around your physical constraints',
        'ASSESSMENT_NEEDED': 'developing a personalised assessment'
      };

      const focus = bottleneckLabels[bottleneck] || bottleneck.toLowerCase();

      let template = `Thank you for completing the performance audit.

Based on your responses, I've identified that ${focus} is likely the primary area we need to address to help you reach your goals.`;

      if (reasons.length > 0) {
        template += `

Key observations:
${reasons.map(r => `• ${r}`).join('\n')}`;
      }

      if (segment === 'HOT') {
        template += `

I'd love to discuss this further and create a roadmap to help you achieve your goals. I have availability this week for a quick discovery call where we can dive deeper into your specific situation.`;
      } else if (segment === 'WARM') {
        template += `

I'd be happy to answer any questions you might have about how we could work together. Feel free to reply to this email.`;
      } else {
        template += `

I'll be sharing some helpful resources over the coming weeks that might help you with your ${focus}. Keep an eye on your inbox.`;
      }

      template += `

Best regards`;

      document.getElementById('analysis-draft').value = template;
    }

    async function sendAnalysis() {
      const draft = document.getElementById('analysis-draft').value;
      
      if (!draft || draft.trim().length === 0) {
        alert('Please write or generate an analysis draft first');
        return;
      }

      if (!confirm('Send this analysis to the client?')) {
        return;
      }

      try {
        const res = await fetch(`/api/pt/leads/${encodeURIComponent(leadId)}/send-analysis`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ draft })
        });
        const data = await res.json();
        
        if (data.ok) {
          alert('Analysis sent successfully!');
          document.getElementById('analysis-sent-status').innerHTML = 
            `<span style="color:#00ff88;">✓ Sent ${new Date().toLocaleString()}</span>`;
        } else {
          alert('Failed to send: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Failed to send analysis');
      }
    }

    // Make functions available globally
    window.saveNotes = saveNotes;
    window.generateDraft = generateDraft;
    window.sendAnalysis = sendAnalysis;

    // Load the lead on page load
    loadLead().then(() => {
      // Store lead for template generation (set in loadLead)
    });
  </script>
</body>
</html>
