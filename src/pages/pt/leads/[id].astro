---
import AnalyticsPlausible from '../../../components/AnalyticsPlausible.astro';

// Enable SSR for this page so it can be generated dynamically
export const prerender = false;

const { id } = Astro.params;
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lead Detail - PT Console</title>
  <AnalyticsPlausible />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e5e5e5;
      min-height: 100vh;
    }
    nav {
      background: #1a1a1a;
      border-bottom: 1px solid #2a2a2a;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav h1 {
      font-size: 18px;
      color: #00ff88;
    }
    nav a {
      color: #888;
      text-decoration: none;
      font-size: 13px;
    }
    nav a:hover {
      color: #00ff88;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }
    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }
    .card {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 24px;
    }
    h2 {
      font-size: 18px;
      margin-bottom: 16px;
      color: #fff;
    }
    .field {
      margin-bottom: 16px;
    }
    .field label {
      display: block;
      font-size: 12px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .field .value {
      font-size: 14px;
      color: #ccc;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge.hot { background: rgba(255, 68, 68, 0.2); color: #ff4444; }
    .badge.warm { background: rgba(255, 184, 0, 0.2); color: #ffb800; }
    .badge.nurture { background: rgba(0, 136, 255, 0.2); color: #0088ff; }
    textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      background: #0a0a0a;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
      color: #ccc;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
    }
    select {
      width: 100%;
      padding: 8px 12px;
      background: #0a0a0a;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
      color: #ccc;
      font-size: 14px;
    }
    button {
      padding: 10px 20px;
      background: #00ff88;
      color: #0a0a0a;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover {
      background: #00dd77;
    }
    .empty {
      text-align: center;
      padding: 48px;
      color: #666;
    }
  </style>
</head>
<body>
  <nav>
    <h1>PT Console</h1>
    <a href="/pt">‚Üê Back to Inbox</a>
  </nav>

  <div class="container">
    <div class="grid">
      <div>
        <div class="card">
          <h2>Lead Information</h2>
          <div id="lead-info" class="empty">Loading lead details...</div>
        </div>

        <div class="card" style="margin-top: 24px;">
          <h2>Quiz Answers</h2>
          <div id="quiz-answers" class="empty">Loading answers...</div>
        </div>
      </div>

      <div>
        <div class="card">
          <h2>Triage & Scoring</h2>
          <div id="triage-info" class="empty">Loading...</div>
        </div>

        <div class="card" style="margin-top: 24px;">
          <h2>Internal Notes</h2>
          <div class="field">
            <label>Notes</label>
            <textarea id="notes-field" placeholder="Add internal notes..."></textarea>
          </div>
          <div class="field">
            <label>Status</label>
            <select id="status-field">
              <option value="NEW">New</option>
              <option value="IN_REVIEW">In Review</option>
              <option value="CLOSED">Closed</option>
            </select>
          </div>
          <button onclick="saveNotes()">Save Notes</button>
        </div>

        <div class="card" style="margin-top: 24px;">
          <h2>Uploads</h2>
          <div id="uploads-list" class="empty">No uploads</div>
        </div>
      </div>
    </div>
  </div>

  <script define:vars={{ id }}>
    const leadId = id;
    
    function esc(s) {
      return String(s ?? '').replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      try {
        return new Date(dateStr).toLocaleString();
      } catch {
        return dateStr;
      }
    }

    function getBadgeClass(segment) {
      switch (segment?.toUpperCase()) {
        case 'HOT': return 'badge hot';
        case 'WARM': return 'badge warm';
        case 'NURTURE': return 'badge nurture';
        case 'DISQUALIFIED': return 'badge disqualified';
        default: return 'badge';
      }
    }

    async function loadLead() {
      try {
        const res = await fetch(`/api/pt/leads/${encodeURIComponent(leadId)}`, {
          headers: { 'Accept': 'application/json' }
        });
        const data = await res.json();

        if (!res.ok || !data.ok) {
          document.getElementById('lead-info').innerHTML = `<div class="empty">Error: ${esc(data.error || 'Failed to load lead')}</div>`;
          return;
        }

        const lead = data.lead;
        const uploads = data.uploads || [];

        // Render lead info
        document.getElementById('lead-info').innerHTML = `
          <div class="field"><label>Email</label><div class="value">${esc(lead.client_email || lead.email)}</div></div>
          <div class="field"><label>Name</label><div class="value">${esc(lead.client_first_name || lead.first_name || 'N/A')}</div></div>
          <div class="field"><label>Location</label><div class="value">${esc(lead.client_location || lead.location || 'N/A')}</div></div>
          <div class="field"><label>Submitted</label><div class="value">${formatDate(lead.created_at)}</div></div>
          <div class="field"><label>Goal</label><div class="value">${esc(lead.goal || lead.main_goal || 'N/A')}</div></div>
          <div class="field"><label>Start Timeline</label><div class="value">${esc(lead.start_timeline || lead.start_timing || 'N/A')}</div></div>
          <div class="field"><label>Coaching Preference</label><div class="value">${esc(lead.coaching_preference || 'N/A')}</div></div>
        `;

        // Render triage info
        const segment = lead.triage_segment || 'UNKNOWN';
        const score = lead.triage_score ?? 'N/A';
        const bottleneck = lead.inferred_bottleneck || 'UNKNOWN';
        const confidence = lead.inferred_confidence || 'N/A';
        
        document.getElementById('triage-info').innerHTML = `
          <div class="field"><label>Segment</label><div class="value"><span class="${getBadgeClass(segment)}">${esc(segment)}</span></div></div>
          <div class="field"><label>Score</label><div class="value">${esc(score)}</div></div>
          <div class="field"><label>Bottleneck</label><div class="value">${esc(bottleneck)} (${esc(confidence)})</div></div>
          <div class="field"><label>Fit Risk</label><div class="value">${lead.fit_risk ? 'Yes' : 'No'}</div></div>
        `;

        // Render quiz answers
        let answersHtml = '';
        try {
          const answers = lead.answers_raw_json ? JSON.parse(lead.answers_raw_json) : {};
          for (const [key, value] of Object.entries(answers)) {
            if (key !== 'company' && key !== 'consent') {
              answersHtml += `<div class="field"><label>${esc(key.replace(/_/g, ' '))}</label><div class="value">${esc(value)}</div></div>`;
            }
          }
        } catch {
          answersHtml = `
            <div class="field"><label>Biggest Blocker</label><div class="value">${esc(lead.biggest_blocker || 'N/A')}</div></div>
            <div class="field"><label>Training Days/Week</label><div class="value">${esc(lead.training_days_now || 'N/A')}</div></div>
            <div class="field"><label>Time Commitment</label><div class="value">${esc(lead.time_commitment_weekly || 'N/A')}</div></div>
            <div class="field"><label>Monthly Budget</label><div class="value">${esc(lead.budget_monthly || 'N/A')}</div></div>
            <div class="field"><label>Constraints</label><div class="value">${esc(lead.injury_notes || (lead.injury_flag ? 'Has constraints' : 'None'))}</div></div>
            <div class="field"><label>Wants Upload</label><div class="value">${lead.wants_upload_stats ? 'Yes' : 'No'}</div></div>
          `;
        }
        document.getElementById('quiz-answers').innerHTML = answersHtml || '<div class="empty">No answers recorded</div>';

        // Load existing notes and status
        document.getElementById('notes-field').value = lead.internal_notes || '';
        document.getElementById('status-field').value = lead.status || 'NEW';

        // Render uploads
        if (uploads.length > 0) {
          document.getElementById('uploads-list').innerHTML = uploads.map(u => `
            <div class="field">
              <label>${formatDate(u.created_at)}</label>
              <div class="value">
                <strong>${esc(u.file_name)}</strong>
                <span style="color:#666; font-size:12px;"> (${(u.file_size_bytes / 1024).toFixed(1)} KB)</span>
              </div>
            </div>
          `).join('');
        } else {
          document.getElementById('uploads-list').innerHTML = '<div class="empty">No uploads</div>';
        }

      } catch (err) {
        console.error('Load lead error:', err);
        document.getElementById('lead-info').innerHTML = `<div class="empty">Failed to load lead data</div>`;
      }
    }

    async function saveNotes() {
      const notes = document.getElementById('notes-field').value;
      const status = document.getElementById('status-field').value;

      try {
        const res = await fetch(`/api/pt/leads/${encodeURIComponent(leadId)}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ notes, status })
        });
        const data = await res.json();
        
        if (data.ok) {
          alert('Notes saved!');
        } else {
          alert('Failed to save: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Failed to save notes');
      }
    }

    // Make saveNotes available globally
    window.saveNotes = saveNotes;

    // Load the lead on page load
    loadLead();
  </script>
</body>
</html>
